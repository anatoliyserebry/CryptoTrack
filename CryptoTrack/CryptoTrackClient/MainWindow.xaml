<Window x:Class="CryptoTrack.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:CryptoTrack"
        xmlns:vm="clr-namespace:CryptoTrack.ViewModels"
        xmlns:converters="clr-namespace:CryptoTrack.Converters"
        xmlns:oxy="http://oxyplot.org/wpf"
        mc:Ignorable="d"
        Title="CryptoTrack - Отслеживание курсов криптовалют"
        Height="600"
        Width="900"
        WindowStartupLocation="CenterScreen">

	<Window.Resources>
		<converters:PriceColorConverter x:Key="PriceColorConverter"/>
		<converters:PriceChangeIconConverter x:Key="PriceChangeIconConverter"/>
		<converters:BooleanToStarConverter x:Key="BooleanToStarConverter"/>
		<converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
		<converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
	</Window.Resources>

	<Grid>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<!-- Заголовок -->
		<Border Grid.Row="0" Background="#2C3E50" Padding="20">
			<StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
				<TextBlock Text="💰" FontSize="28" Margin="0,0,10,0"/>
				<TextBlock Text="CryptoTrack"
                          FontSize="24"
                          FontWeight="Bold"
                          Foreground="White"/>
				<TextBlock Text=" - Отслеживание курсов криптовалют"
                          FontSize="16"
                          Foreground="#BDC3C7"
                          Margin="10,0,0,0"/>
			</StackPanel>
		</Border>

		<!-- Основное содержимое -->
		<Grid Grid.Row="1" Margin="10">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="*"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>

			<!-- Панель управления (список) -->
			<StackPanel Grid.Column="0"
                       Orientation="Horizontal"
                       HorizontalAlignment="Left"
                       Visibility="{Binding ShowChart, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=inverse}">
				<Button Content="🔄 Обновить"
                        Command="{Binding RefreshCommand}"
                        ToolTip="Обновить данные"/>
				<Button Content="⭐ Избранные"
                        Command="{Binding ShowFavoritesCommand}"
                        ToolTip="Показать избранные валюты"/>
				<Button Content="📋 Все"
                        Command="{Binding ShowAllCommand}"
                        ToolTip="Показать все валюты"/>

				<TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                        Width="200"
                        Margin="20,0,0,0"
                        Padding="8,4"
                        VerticalContentAlignment="Center">
					<TextBox.Style>
						<Style TargetType="TextBox">
							<Setter Property="Template">
								<Setter.Value>
									<ControlTemplate TargetType="TextBox">
										<Grid>
											<Border Background="#ECF0F1"
                                                    CornerRadius="4"
                                                    Padding="2">
												<Grid>
													<TextBlock Text="🔍 Поиск..."
                                                              Foreground="#7F8C8D"
                                                              VerticalAlignment="Center"
                                                              HorizontalAlignment="Left"
                                                              Margin="8,0,0,0"
                                                              Visibility="{Binding Text, 
                                                                        RelativeSource={RelativeSource TemplatedParent}, 
                                                                        Converter={StaticResource StringToVisibilityConverter}}"/>
													<ScrollViewer x:Name="PART_ContentHost"
                                                                  VerticalAlignment="Center"/>
												</Grid>
											</Border>
										</Grid>
									</ControlTemplate>
								</Setter.Value>
							</Setter>
						</Style>
					</TextBox.Style>
				</TextBox>
			</StackPanel>

			<!-- Панель управления (график) -->
			<StackPanel Grid.Column="0"
                       Orientation="Horizontal"
                       HorizontalAlignment="Left"
                       Visibility="{Binding ShowChart, Converter={StaticResource BooleanToVisibilityConverter}}">
				<Button Content="← Назад"
                        Command="{Binding BackCommand}"
                        ToolTip="Вернуться к списку"/>
				<Button Content="1 День"
                        Command="{Binding ShowDayChartCommand}"
                        Margin="10,0,0,0"
                        ToolTip="Показать график за 1 день"/>
				<Button Content="1 Неделя"
                        Command="{Binding ShowWeekChartCommand}"
                        ToolTip="Показать график за 1 неделю"/>
				<Button Content="1 Месяц"
                        Command="{Binding ShowMonthChartCommand}"
                        ToolTip="Показать график за 1 месяц"/>

				<TextBlock Text="{Binding ChartTitle}"
                          FontSize="16"
                          FontWeight="Bold"
                          Margin="20,0,0,0"
                          VerticalAlignment="Center"/>
			</StackPanel>

			<!-- Статус загрузки -->
			<StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
				<ProgressBar Width="100"
                            Height="10"
                            IsIndeterminate="{Binding IsLoading}"
                            Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"
                            Margin="0,0,10,0"/>
				<TextBlock Text="{Binding Cryptocurrencies.Count, StringFormat='Всего: {0}'}"/>
			</StackPanel>

			<!-- Список криптовалют -->
			<Grid Grid.Row="1" Grid.ColumnSpan="2" Margin="0,40,0,0">
				<Grid.Style>
					<Style TargetType="Grid">
						<Setter Property="Visibility" Value="Visible"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding ShowChart}" Value="True">
								<Setter Property="Visibility" Value="Collapsed"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Grid.Style>

				<ListView ItemsSource="{Binding FilteredCurrencies}"
                         SelectedItem="{Binding SelectedCrypto}"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled">
					<ListView.View>
						<GridView>
							<GridViewColumn Header="Избранное" Width="80">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<Button Content="{Binding IsFavorite, Converter={StaticResource BooleanToStarConverter}}"
                                                Command="{Binding DataContext.ToggleFavoriteCommand, 
                                                          RelativeSource={RelativeSource AncestorType=ListView}}"
                                                CommandParameter="{Binding Id}"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                FontSize="16"
                                                ToolTip="Добавить/удалить из избранного"/>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Название" Width="150">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<StackPanel Orientation="Horizontal">
											<TextBlock Text="{Binding Symbol}"
                                                      FontWeight="Bold"
                                                      Margin="0,0,10,0"
                                                      Width="50"/>
											<TextBlock Text="{Binding Name}"
                                                      TextTrimming="CharacterEllipsis"/>
										</StackPanel>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Цена (USD)" Width="120">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<TextBlock Text="{Binding CurrentPrice, StringFormat='{}{0:C2}'}"
                                                  FontWeight="Bold"/>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Изменение 24ч" Width="150">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<StackPanel Orientation="Horizontal">
											<TextBlock Text="{Binding PriceChangePercentage24h, 
                                                               Converter={StaticResource PriceChangeIconConverter}}"
                                                      Foreground="{Binding PriceChange24h, 
                                                                 Converter={StaticResource PriceColorConverter}}"/>
											<TextBlock Text="{Binding PriceChange24h, StringFormat='{}{0:C2}'}"
                                                      Margin="5,0,0,0"/>
											<TextBlock Text="{Binding PriceChangePercentage24h, StringFormat=' ({0:F2}%)'}"
                                                      Foreground="{Binding PriceChange24h, 
                                                                 Converter={StaticResource PriceColorConverter}}"/>
										</StackPanel>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Капитализация" Width="150">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<TextBlock Text="{Binding MarketCap, StringFormat='{}{0:C0}'}"
                                                  TextTrimming="CharacterEllipsis"/>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Обновлено" Width="150">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<TextBlock Text="{Binding LastUpdated, StringFormat='{}{0:HH:mm:ss}'}"/>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>

							<GridViewColumn Header="Действия" Width="100">
								<GridViewColumn.CellTemplate>
									<DataTemplate>
										<Button Content="📊 График"
                                                Command="{Binding DataContext.ShowChartCommand, 
                                                          RelativeSource={RelativeSource AncestorType=ListView}}"
                                                CommandParameter="{Binding Id}"
                                                ToolTip="Показать график изменения цены"/>
									</DataTemplate>
								</GridViewColumn.CellTemplate>
							</GridViewColumn>
						</GridView>
					</ListView.View>

					<ListView.ItemContainerStyle>
						<Style TargetType="ListViewItem">
							<Setter Property="HorizontalContentAlignment" Value="Stretch"/>
							<Setter Property="Padding" Value="5"/>
							<Style.Triggers>
								<Trigger Property="IsMouseOver" Value="True">
									<Setter Property="Background" Value="#ECF0F1"/>
								</Trigger>
								<Trigger Property="IsSelected" Value="True">
									<Setter Property="Background" Value="#3498DB"/>
									<Setter Property="Foreground" Value="White"/>
								</Trigger>
							</Style.Triggers>
						</Style>
					</ListView.ItemContainerStyle>
				</ListView>
			</Grid>

			<!-- Область для графика -->
			<Grid Grid.Row="1" Grid.ColumnSpan="2" Margin="0,40,0,0">
				<Grid.Style>
					<Style TargetType="Grid">
						<Setter Property="Visibility" Value="Collapsed"/>
						<Style.Triggers>
							<DataTrigger Binding="{Binding ShowChart}" Value="True">
								<Setter Property="Visibility" Value="Visible"/>
							</DataTrigger>
						</Style.Triggers>
					</Style>
				</Grid.Style>

				<Border Background="White" CornerRadius="5" Padding="10">
					<Grid>
						<Grid.RowDefinitions>
							<RowDefinition Height="*"/>
							<RowDefinition Height="Auto"/>
						</Grid.RowDefinitions>

						<!-- Сам график -->
						<oxy:PlotView Grid.Row="0"
                            Model="{Binding PriceChartModel}"
                            Background="White">
						</oxy:PlotView>

						<!-- Информация о валюте -->
						<Border Grid.Row="1"
                               Background="#ECF0F1"
                               CornerRadius="5"
                               Margin="0,10,0,0"
                               Padding="10">
							<Grid>
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
									<ColumnDefinition Width="Auto"/>
									<ColumnDefinition Width="*"/>
								</Grid.ColumnDefinitions>

								<TextBlock Text="Название:" FontWeight="Bold" Margin="5"/>
								<TextBlock Grid.Column="1" Text="{Binding SelectedCrypto.Name}" Margin="5"/>

								<TextBlock Grid.Column="2" Text="Символ:" FontWeight="Bold" Margin="5"/>
								<TextBlock Grid.Column="3" Text="{Binding SelectedCrypto.Symbol}" Margin="5"/>

								<TextBlock Grid.Column="4" Text="Текущая цена:" FontWeight="Bold" Margin="5"/>
								<TextBlock Grid.Column="5"
                                          Text="{Binding SelectedCrypto.CurrentPrice, StringFormat='{}{0:C2}'}"
                                          FontWeight="Bold"
                                          Foreground="{Binding SelectedCrypto.PriceChange24h, Converter={StaticResource PriceColorConverter}}"
                                          Margin="5"/>
							</Grid>
						</Border>
					</Grid>
				</Border>
			</Grid>
		</Grid>

		<!-- Статус бар -->
		<StatusBar Grid.Row="2" Background="#34495E">
			<StatusBarItem>
				<TextBlock Foreground="White" Text="CryptoTrack v1.0"/>
			</StatusBarItem>
			<Separator/>
			<StatusBarItem>
				<TextBlock Foreground="#BDC3C7"
                          Text="{Binding SelectedCrypto.Name, StringFormat='Выбрано: {0}'}"/>
			</StatusBarItem>
			<Separator/>
			<StatusBarItem>
				<CheckBox IsChecked="{Binding AutoRefreshEnabled}"
                          Content="Автообновление"
                          Foreground="#BDC3C7"
                          Margin="5,0"/>
			</StatusBarItem>
			<Separator/>
			<StatusBarItem HorizontalAlignment="Right">
				<TextBlock Foreground="#BDC3C7"
                          Text="{Binding Favorites.Count, StringFormat='Избранные: {0}'}"/>
			</StatusBarItem>
		</StatusBar>
	</Grid>
</Window>